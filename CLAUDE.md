# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

"Piece of Code" is a Streamlit-based interactive code playground that allows users to write and execute code snippets in multiple languages (Python, Streamlit, HTML/CSS/JavaScript) with live preview. Users can select examples, edit code in a built-in editor, and see results in real-time with adjustable side-by-side or tabbed layouts.

## Development Setup

This project uses `uv` for fast Python dependency management and `make` for common tasks.

### Initial Setup
```sh
make init  # Initialize virtual environment and install dependencies + pre-commit hooks
```

### Running the Application
```sh
make dev  # Start Streamlit with auto-reload on file changes
```

This runs: `uv run streamlit run src/main.py --server.fileWatcherType auto --server.runOnSave true`

### Code Quality
```sh
make check  # Update and run pre-commit hooks (Ruff linting + formatting)
```

Pre-commit hooks automatically:
- Export dependencies to requirements.txt
- Lock dependencies with uv
- Fix import sorting (Ruff with `--select I`)
- Fix other code issues (Ruff with `--fix`)
- Format code (Ruff formatter)

### Cleanup
```sh
make clean  # Remove .venv, .ruff_cache, .pytest_cache, and .coverage
```

## Architecture

### Engine System (Plugin Architecture)

The application uses an **engine pattern** where each language/runtime is implemented as a separate engine class. All engines inherit from `BaseEngine` ([src/engines/base_engine.py](src/engines/base_engine.py)) which defines the interface:

- `language` property: Returns the language identifier for the code editor
- `run(code, container)`: Executes/renders code within a Streamlit container
- `list_examples()`: Returns available example files for that engine

**Available Engines:**
- **PythonEngine** ([src/engines/python/python_engine.py](src/engines/python/python_engine.py)): Executes Python code with `exec()`, captures stdout, blocks dangerous imports (os, sys, subprocess, shutil, pathlib, socket)
- **StreamlitEngine** ([src/engines/streamlit/streamlit_engine.py](src/engines/streamlit/streamlit_engine.py)): Similar to PythonEngine but injects `st` into globals for Streamlit API access
- **JSEngine** ([src/engines/js/js_engine.py](src/engines/js/js_engine.py)): Renders HTML/CSS/JavaScript using `streamlit.components.v1.html()`

**Engine Registration:**
Engines are registered in [src/config.py](src/config.py) via `ENGINE_MAPPING` which maps `Engine` enum values to engine classes.

### Main Application Flow

[src/main.py](src/main.py) orchestrates the UI:

1. **Settings Sidebar** (`get_settings()`): Engine selector, example selector, panel resize slider, swap panels toggle
2. **Panel Layout** (`get_panels()`): Dynamically switches between side-by-side columns and tabs based on split ratio thresholds
3. **Code Editor Panel**: Uses `streamlit-code-editor` with custom buttons (Run button bound to Cmd/Ctrl+Enter)
4. **Preview Panel**: Executes code via the selected engine's `run()` method

**Key Layout Logic:**
- Split ratio determines whether to show side-by-side or tabbed layout
- Thresholds defined by `CODE_PREVIEW_THRESHOLD` in config
- Swap panels toggle reverses the order of code/preview

### Examples System

Each engine stores example files in its `examples/` subdirectory:
- Python: `src/engines/python/examples/*.py`
- Streamlit: `src/engines/streamlit/examples/*.py`
- JavaScript: `src/engines/js/examples/*.html`

Examples are discovered via `list_examples()` and presented in a dropdown, formatted as title-case with underscores replaced by spaces.

## Adding a New Engine

1. Create new directory under `src/engines/{engine_name}/`
2. Implement engine class inheriting from `BaseEngine`
3. Add to `Engine` enum in [src/config.py](src/config.py)
4. Register in `ENGINE_MAPPING` in [src/config.py](src/config.py)
5. Optionally create `examples/` directory with sample files
6. Export from [src/engines/__init__.py](src/engines/__init__.py)

## Dependencies

- **Python**: >=3.11
- **Package Manager**: uv
- **UI Framework**: Streamlit 1.51.0
- **Code Editor**: streamlit-code-editor 0.1.22
- **HTTP Clients**: httpx, requests
- **Data**: pandas, numpy
- **Config**: pydantic-settings
- **Logging**: loguru

Dependencies are managed in [pyproject.toml](pyproject.toml). The [requirements.txt](requirements.txt) is auto-generated by pre-commit hooks and should not be manually edited.

## Safety Constraints

Both PythonEngine and StreamlitEngine block imports of potentially dangerous packages:
- os, sys, subprocess, shutil, pathlib, socket

This is a **basic safety measure** for user-submitted code execution, not a comprehensive sandbox. Code runs via `exec()` with isolated globals but shares the Python interpreter.
